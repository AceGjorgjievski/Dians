<html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<title>FINDIFY</title>
<link rel="stylesheet" href="sliki/css/all.css">
<!--  <link rel="stylesheet" type="text/css" href="sliki/css/all.css">-->
<style>
    body {
        margin: 0;
    }

    #eventsSelectionTable td {
        text-align: center;
        padding: 2% 5%;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
    }

    .header {
        overflow: hidden;
        background-color: #161616;
        padding: 20px 10px;
    }

    .header a {
        float: left;
        color: #FFFFFF;
        text-align: center;
        padding: 12px;
        text-decoration: none;
        font-size: 18px;
        line-height: 25px;
        border-radius: 4px;
    }

    .header a.logo {
        font-size: 25px;
        font-weight: bold;
    }

    .header a:hover {
        background-color: #161616;
        color: #FFFFFF;
    }

    .header a.active {
        background-color: #161616;
        color: #FFFFFF;
    }

    .header-right {
        float: right;
    }

    @media screen and (max-width: 500px) {
        .header a {
            float: none;
            display: block;
            text-align: left;
        }

        .header-right {
            float: none;
        }
    }


    /**
    na velin linkovite za mapa (prvite 2)
     */
</style>

<!--  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>-->
<!--  <script src="http://www.openlayers.org/api/OpenLayers.js"></script>-->
<!--    -->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.js"></script>-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/addons/p5.sound.min.js"></script>-->
<!--&lt;!&ndash;    &ndash;&gt;-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/p5.min.js" type="text/javascript"></script>-->
<!--&lt;!&ndash;    <script src="https://unpkg.com/mappa-mundi/dist/mappa.min.js" type="text/javascript"></script>&ndash;&gt;-->
<!--    <script src="https://unpkg.com/mappa-mundi@0.0.4"></script>-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/addons/p5.dom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mappa-mundi@0.0.4"></script>
</head>
<body>

<div class="header">
    <a href="/home" class="logo">FINDIFY</a>

    <div class="header-right">

        <form th:method="POST" th:action="@{'/home'}">
            <a>
                <select th:name="userOption" th:id="opstina">
                    <option th:selected="selected" th:value="all">All amenities in Skopje</option>
                    <option th:value="local">Nearby Where I am Now</option>
                </select>
            </a>
            <a>
                <button th:type="submit" th:value="submit">Search</button>
            </a>
        </form>

        <a class="btn btn-light" href="/logout"> Logout</a>
        <!--    USER EDIT PROFILE TODO-->
        <!--        TODO: koga kje se selektira "near my location, da se smeni vo drop down listata.."-->
        <!--        so  document.getElementById() ... ? link >>
            >>> https://stackoverflow.com/questions/39238929/passing-variable-from-script-to-html-->
        <!--        isto i Home button-not (kukjata) koga kje se klikne da ostane ona shto bilo selektirano prethodno?-->

        <!--        drop down pole so favorites..? ama otkoga kje ima dodaeno korisnikot vo favorites-->


        <a href="/home"><i class="fa fa-solid fa-house tm-brand-icon"></i></a>
        <a href="/profile"><i class="fa fa-solid fa-pen tm-brand-icon"></i></a>
    </div>

    <div id="demo" style="color: white;">

    </div>

</div>

<div id="mapdiv"></div>
<script th:inline="javascript">
    function isNumber(str) {
        if (typeof str != "string") return false
        return !isNaN(str) &&
            !isNaN(parseFloat(str))
    }


    /**
     * P5 js code....=======================================================================================================================================
     */
    /*<![CDATA[*/
    var myList = /*[[${amenities}]]*/ "Test";
    var whatToShow = /*[[${userOption}]]*/ "Test1";
    /*]]>*/

    let trainMap;
    // Create a variable to hold our canvas
    let canvas;
    // Create a new Mappa instance using Leaflet.
    const mappa = new Mappa('Leaflet');

    let dropPinAmenity;
    let total = myList.length;

    let offsetEllipse = 100;
    let scalar = 20;
    let angle = 10;

    let localAmenities;
    let allAmenities;



    const options = {
        lat: 41.9965,
        lng: 21.4314,
        zoom: 13.75,
        style: "http://{s}.tile.osm.org/{z}/{x}/{y}.png"
    }

    function preload() {
        // dropPinAmenity = loadImage('static/images/drop_pin_amenity.png');

    }

    // p5.js setup
    function setup() {
        // Create a canvas 640x640
        canvas = createCanvas(windowWidth - 10, windowHeight - 100);
        // Add a grey background
        // background(100);
        trainMap = mappa.tileMap(options);
        // Overlay the canvas over the tile map
        trainMap.overlay(canvas);


        trainMap.onChange(drawPoints);
        trainMap.onChange(myPos);
        console.log(total);
        console.log(whatToShow);

        if(whatToShow === "local") {
            localAmenities = true;
            allAmenities = false;
        } else {
            localAmenities = false;
            allAmenities = true;
        }


    }

    function draw() {
        //myPos();
    }

    function myPos() {
        if(localAmenities) {
            fill(0, 255, 0);
            ellipse(windowWidth / 2, windowHeight / 2, 50, 50);
        }
    }

    function drawPoints() {
        clear();

        fill(255, 0, 0);
        let size = 50;
        size = map(size, 558, 60000000, 1, 70) + trainMap.zoom();

        if (whatToShow === "local") {
            //TODO to do local amenities showing...
            console.log("Showing the first 5...");
            for (let i = 0; i < 5; i++) {
                let px = myList[i].longitude;
                let py = myList[i].latitude;
                const pix = trainMap.latLngToPixel(px, py);

                ellipse(pix.x, pix.y, size, size);
                // image('src/main/resources/static/images/drop_pin_amenity.png', pix.x, pix.y);
            }
        } else {
            console.log("Showing all...");
            for (let i = 0; i < myList.length; i++) {
                let px = myList[i].longitude;
                let py = myList[i].latitude;
                const pix = trainMap.latLngToPixel(px, py);
                ellipse(pix.x, pix.y, size, size);
                // image('src/main/resources/static/images/drop_pin_amenity.png', pix.x, pix.y);
            }
        }
    }


    /**
     * P5 js code....=======================================================================================================================================
     */

    function updateUrlHash() {
        var zoom = map.getZoom();
        var lonLat = map.getCenter().transform(
            new OpenLayers.Projection("EPSG:3857"),
            new OpenLayers.Projection("EPSG:4326")
        );
        window.location.hash = lonLat.lon.toFixed(7) + '/' + lonLat.lat.toFixed(7) + '/' + zoom;
    }

    function logoutFunc() {
        window.location = "login";
        document.write("Logging out...");
        setTimeout('logoutFunc()', 900);
    }


    map = new OpenLayers.Map("mapdiv");
    map.addLayer(new OpenLayers.Layer.OSM());

    var pathHash = window.location.hash.substring(1).split('/');

    var lon = 21.4248746;
    var lat = 41.9960555;
    var zoom = 14;
    if (pathHash.length === 3) {
        if (isNumber(pathHash[0]))
            lon = pathHash[0];
        if (isNumber(pathHash[1]))
            lat = pathHash[1];
        if (isNumber(pathHash[2]))
            zoom = pathHash[2];
    } else {
        window.location.hash = "21.4248746/41.9960555/14";
    }

    var lonLat = new OpenLayers.LonLat(lon, lat)
        .transform(
            new OpenLayers.Projection("EPSG:4326"),
            new OpenLayers.Projection("EPSG:3857")
        );

    var markers = new OpenLayers.Layer.Markers("Markers");
    map.addLayer(markers);
    var size = new OpenLayers.Size(45, 45);
    var offset = new OpenLayers.Pixel(-(size.w / 2), 0);

    map.setCenter(lonLat, zoom);
    map.events.register('moveend', map, updateUrlHash);

</script>
<script>
    var x = document.getElementById("demo");

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            x.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function showPosition(position) {
        x.innerHTML = "Latitude: " + position.coords.latitude +
            "<br>Longitude: " + position.coords.longitude;
    }
</script>


</body>

</html>